<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="../css/battle.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../js/changePage.js"></script>
<!--  <script src="../js/battle.js"></script>-->
  <title>Do battle - 배틀</title>
</head>
<body>

<div id="real-top">
  <div id="battle-top">
    <div><img src="/image/arrow.svg" onclick = "changePage('../doingBattleList')"></div>
    <div id="write">배틀 상세보기</div>
    <div id="nothing"></div>
  </div>

  <div id="battle-detail">
    <div>
      <div id="detail-text">
        <span id="date">xx.xx~xx.xx<br></span>
        <span th:text="${battleName}" id="name">배틀 이름</span>
      </div>
      <div><img src="/image/small-fire.svg"></div>
    </div>
    <div><img src="/image/calendar.svg" onclick="goToBattlePage(this)"></div>
  </div>

  <div id="battle-progress">
    <div id="me">
      <div class="progress">
        <div class="first">60%</div>
        <img src="/image/progress-face-1.svg">
      </div>
      <p th:text="${currentUser.username}">김배틀</p>
    </div>

    <div id="vs">vs</div>

    <div id="other">
      <p th:text="${partnerUsernames}">박상대</p>  <!--username-->
      <div class="progress">
        <div class="first">26%</div>
        <img src="/image/progress-face-2.svg">
      </div>
    </div>
  </div>

  <div id="text">김배틀님이 34% 차이로<br>앞서가고 있어요!</div>
</div>

<div id="battle-bottom">
  <div id="todo-main">
    <div>TO-DO</div>
    <img onclick="todoClick()" src="/image/todo-fire-make.svg" style="cursor:pointer;">
  </div>

  <form th:action="@{'/battle/' + ${battleCode} + '/saveTodoData'}" method="post" th:each="todoDate : ${todoDataList}">
    <div th:text="${todoDate.todoDataValue}" class="todo-list">오늘의 todo리스트입니다.</div>
    <input type="submit" name="value" class="fire-button" th:value="${todoDate.value}">
    <input type="hidden" name="todoDataValue" class="todoDataValue" th:value="${todoDate.todoDataValue}">
  </form>

<!--  <form th:action="@{'/battle/' + ${battleCode} + '/saveTodoData'}" method="post">-->
<!--    <div class="todo-list">오늘의 todo리스트입니다.</div>-->
<!--    <input type="submit" name="value" class="fire-button" value="notDone">-->
<!--    <input type="hidden" name="todoDataValue" class="todoDataValue" value="내용">-->
<!--    <input type="hidden" name="percentage" id="">-->
<!--  </form>-->
  <script src="../js/battle.js"></script>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let start = /*[[${startDate}]]*/;
    var splitStart = start.split('-');
    let startDate = splitStart[1] + '.' + splitStart[2];

    let end = /*[[${endDate}]]*/;
    var splitEnd = end.split('-');
    let endDate = splitEnd[1] + '.' + splitEnd[2];

    document.querySelector('#date').innerText = startDate + '~' +endDate;

  //폼태그에 경로 추가
  var battleCode = /*[[${battleCode}]]*/;
  /*]]>*/


  function goToBattlePage(element) {
    var battleCode = /*[[${battleCode}]]*/;
    window.location.href = '/calender/detail?battleCode=' + battleCode;
  }

<!--  function todoClick(){-->
<!--    while(txtFieldNum === 0){-->
<!--      let todo; //입력한 문구 저장용-->
<!--      let battleBottom = document.getElementById("battle-bottom");-->

<!--      battleBottom.innerHTML = `-->
<!--        <form th:action="@{'/battle/' + ${battleCode} + '/saveTodoData'}" method="post">-->
<!--          <input type="text" class="input-text" placeholder="입력">오늘의 투두리스트입니다.</div>-->
<!--        </form>-->
<!--      `-->

<!--      txtFieldNum++;-->

<!--      let newText = document.querySelector('input');-->
<!--    }-->

function todoClick() {
  while (txtFieldNum === 0) {
    let todo;   //입력한 문구 저장용
    let battleBottom = document.getElementById("battle-bottom");

    let newDiv = document.createElement("div"); // 전체 감쌀 div
    let newText = document.createElement("input");
    newText.type = "text";
    newText.className = "input-text";
    newText.placeholder = "입력";

    battleBottom.appendChild(newDiv);
    newDiv.appendChild(newText);

    txtFieldNum++; // 줄줄이 방지

    newText.addEventListener("keyup", function (event) {
      if (event.key === "Enter") {
        todo = newText.value;
//        if (!todo) {
//            alert("오늘 할 일을 입력하세요.");
//            return;
//        }
        battleBottom.removeChild(newDiv);   //위에 input으로 만든거 전체 삭제

        let newDiv2 = document.createElement("form");    //밖에 감싸줄 form 태그
        newDiv2.setAttribute("action", '/battle/' + battleCode + '/saveTodoData');    //html안의 js 파일에서 제어해줄것
        newDiv2.setAttribute("method", "post");

        let todoList = document.createElement("div");   //todo 저장
        todoList.className = "todo-list";
        todoList.innerText = todo;

        let fireImg = document.createElement("input"); // 불 input 체크박스
        fireImg.type = "submit";
        fireImg.value = "notDone";
        fireImg.className = "fire-button";
        fireImg.name = "value";

        let hiddenInput1 = document.createElement("input");
        hiddenInput1.type = "hidden"; // 숨겨진 필드로 데이터 전달
        hiddenInput1.name = "todoDataValue"; // 백엔드에서 사용
        hiddenInput1.value = todo;
        hiddenInput1.className = "todoDataValue";

        battleBottom.appendChild(newDiv2);
        newDiv2.appendChild(todoList);
        newDiv2.appendChild(fireImg);
        newDiv2.appendChild(hiddenInput1);

        todoNum++;
        txtFieldNum--;
      }
    });
  }
}
</script>

</body>
</html>